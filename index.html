<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CST3144 Lessons Shop</title>
  <meta name="description" content="CST3144 Vue front-end: lessons list, sorting, cart, and checkout." />

  <!-- CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link rel="stylesheet" href="src/styles.css">

  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="favicon.ico">

  <!-- Vue (global build) -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <style>
    .subject-icon { font-size: 2rem; width: 2.25rem; text-align: center; }
    button:disabled { opacity: .6; cursor: not-allowed; }
  </style>
</head>

<body class="bg-light">
  <div id="app" class="container py-4">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 m-0">After-School Classes</h1>
      <button class="btn btn-outline-secondary"
              :disabled="cart.length === 0"
              @click="viewCart = !viewCart">
        <i class="fa-solid fa-cart-shopping"></i>
        <span class="ms-1">Cart ({{ cart.length }})</span>
      </button>
    </header>

    <!-- error banner -->
    <div v-if="error" class="alert alert-danger">{{ error }}</div>

    <!-- LESSON LIST -->
    <main v-if="!viewCart">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
        <label class="me-1 mb-0">Sort by:</label>
        <select v-model="sortBy" class="form-select w-auto" aria-label="Sort lessons by">
          <option value="topic">Subject</option>
          <option value="location">Location</option>
          <option value="price">Price</option>
          <option value="space">Spaces</option>
        </select>
        <select v-model="sortDir" class="form-select w-auto" aria-label="Sort direction">
          <option value="asc">Ascending</option>
          <option value="desc">Descending</option>
        </select>

        <!-- Search box (depending on what letters you are writing different lessons will come up) -->
        <div class="ms-auto">
          <input
            v-model="searchTerm"
            class="form-control"
            placeholder="Search lessons..."
            aria-label="Search lessons"
          />
        </div>
      </div>

      <div class="row g-3">
        <div class="col-md-4" v-for="l in sortedLessons" :key="l.id">
          <div class="card h-100">
            <div class="d-flex align-items-center p-3 border-bottom">
              <i :class="['subject-icon', subjectIcon(l.topic)]" :title="l.topic" aria-hidden="true"></i>
            </div>

            <div class="card-body d-flex flex-column">
              <h5 class="card-title">
                <i class="fa-solid fa-book-open me-2"></i>{{ l.topic }}
              </h5>
              <p class="mb-1"><strong>Location:</strong> {{ l.location }}</p>
              <p class="mb-1"><strong>Price:</strong> £{{ l.price }}</p>
              <p class="mb-2"><strong>Spaces:</strong> {{ l.space }}</p>

              <p class="mb-3">
                <span v-if="l.space > 3" class="text-success">Available</span>
                <span v-else-if="l.space > 0" class="text-warning">Only {{ l.space }} left!</span>
                <span v-else class="text-danger">All out!</span>
              </p>

              <button class="btn btn-primary mt-auto"
                      :disabled="l.space === 0"
                      @click="addToCart(l)">
                Add to cart
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- CART + CHECKOUT -->
    <main v-else>
      <h2 class="h5 mb-3">Your Cart</h2>

      <div v-if="cart.length === 0" class="alert alert-info">Cart is empty.</div>

      <ul class="list-group mb-3" v-else>
        <li class="list-group-item d-flex justify-content-between align-items-center"
            v-for="item in cart" :key="item.id">
          <div>
            <strong>{{ item.topic }}</strong>
            <small class="text-muted"> — £{{ item.price }} × {{ item.qty }}</small>
          </div>
          <div class="d-flex align-items-center gap-3">
            <span>£{{ item.price * item.qty }}</span>
            <button class="btn btn-sm btn-outline-danger" @click="removeFromCart(item)">Remove</button>
          </div>
        </li>
      </ul>

      <div class="border rounded p-3 mb-3">
        <h3 class="h6 mb-3">Checkout</h3>
        <div class="row g-2">
          <div class="col-md-4">
            <input class="form-control" placeholder="Name (letters only)" v-model.trim="name" />
            <small v-if="name && !validName" class="text-danger">Name must be letters only.</small>
          </div>
          <div class="col-md-4">
            <input class="form-control" placeholder="Phone (digits; + and spaces allowed)" v-model.trim="phone" />
            <small v-if="phone && !validPhone" class="text-danger">
              Enter 7–15 digits (you can include + and spaces).
            </small>
          </div>
          <div class="col-md-4">
            <button class="btn btn-success w-100" :disabled="!canCheckout" @click="checkout">Checkout</button>
          </div>
        </div>
      </div>

      <button class="btn btn-secondary" @click="viewCart=false">← Back to lessons</button>
    </main>
  </div>

  <!-- App logic (module; uses global Vue and your src/api.js) -->
  <script type="module">
    import {
      fetchLessons,
      createOrder,
      updateLessonSpace,
      searchLessons
    } from './src/api.js';

    const { createApp } = Vue; // from the global script in <head>

    createApp({
      data() {
        return {
          viewCart: false,
          cart: [],                 // [{ id, topic, price, qty }]
          sortBy: 'topic',
          sortDir: 'asc',
          name: '',
          phone: '',
          lessons: [],              // loaded from backend
          error: '',
          searchTerm: ''            // for search-as-you-type
        };
      },

      mounted() {
        this.loadAllLessons();
      },

      computed: {
        sortedLessons() {
          const key = this.sortBy;
          const dir = this.sortDir === 'asc' ? 1 : -1;
          return [...this.lessons].sort((a, b) => {
            const A = a[key];
            const B = b[key];
            if (typeof A === 'number' && typeof B === 'number') {
              return (A - B) * dir;
            }
            return String(A).localeCompare(String(B)) * dir;
          });
        },
        cleanPhone() { return (this.phone || '').replace(/[^\d]/g, '') },
        validName()  { return /^[A-Za-z\s'-]{2,}$/.test(this.name) },
        validPhone() { const n = this.cleanPhone.length; return n >= 7 && n <= 15 },
        canCheckout(){ return this.cart.length > 0 && this.validName && this.validPhone }
      },

      watch: {
        // search as you type
        searchTerm(newValue) {
          this.runSearch(newValue);
        }
      },

      methods: {
        loadAllLessons() {
          this.error = '';
          fetchLessons()
            .then(data => {
              this.lessons = data;
            })
            .catch(err => {
              console.error(err);
              this.error = 'Could not load lessons';
            });
        },

        runSearch(query) {
          this.error = '';

          const trimmed = (query || '').trim();
          if (!trimmed) {
            // empty search -> reload all
            this.loadAllLessons();
            return;
          }

          searchLessons(trimmed)
            .then(data => {
              this.lessons = data;
            })
            .catch(err => {
              console.error(err);
              this.error = 'Search failed';
            });
        },

        subjectIcon(topic) {
          const map = {
            'Mathematics': 'fa-solid fa-square-root-variable',
            'English Literature': 'fa-solid fa-book',
            'Physics': 'fa-solid fa-atom',
            'Chemistry': 'fa-solid fa-flask-vial',
            'Biology': 'fa-solid fa-dna',
            'Computer Science': 'fa-solid fa-code',
            'History': 'fa-solid fa-landmark',
            'Geography': 'fa-solid fa-globe',
            'Art': 'fa-solid fa-palette',
            'Music': 'fa-solid fa-music'
          };
          return map[topic] || 'fa-solid fa-book';
        },

        addToCart(lesson) {
          if (lesson.space === 0) return;
          lesson.space -= 1; // reflect locally
          const existing = this.cart.find(i => i.id === lesson.id);
          if (existing) {
            existing.qty += 1;
          } else {
            this.cart.push({
              id: lesson.id,
              topic: lesson.topic,
              price: lesson.price,
              qty: 1
            });
          }
        },

        removeFromCart(item) {
          const lesson = this.lessons.find(l => l.id === item.id);
          if (lesson) {
            lesson.space += item.qty;
          }
          this.cart = this.cart.filter(i => i.id !== item.id);
        },

        // POST /orders then try to PUT /lessons/:id for each item
        checkout() {
          if (!this.canCheckout) return;

          this.error = '';

          const items = this.cart.map(c => ({ id: c.id, qty: c.qty || 1 }));

          // 1) create order
          createOrder({ name: this.name, phone: this.phone, items })
            .then(orderResult => {
              console.log('Order created:', orderResult);

              // 2) update lesson spaces (do not fail checkout if PUT fails)
              const updates = this.cart.map(c => {
                const lesson = this.lessons.find(l => l.id === c.id);
                if (!lesson) {
                  console.warn('No lesson found for cart item', c);
                  return Promise.resolve();
                }

                return updateLessonSpace(lesson.id, lesson.space)
                  .then(res => {
                    console.log('Updated lesson space:', res);
                  })
                  .catch(err => {
                    console.error('Failed to update lesson space for', lesson.id, err);
                    // swallow error so checkout still completes
                  });
              });

              return Promise.all(updates);
            })
            .then(() => {
              alert('Order confirmed!');
              this.cart = [];
              this.name = '';
              this.phone = '';
              this.viewCart = false;
            })
            .catch(e => {
              console.error('Checkout error:', e);
              this.error = e?.error || e?.message || 'Checkout failed';
            });
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
